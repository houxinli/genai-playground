# 重复检测功能说明

## 问题背景

在使用大语言模型进行翻译时，有时会遇到模型输出无限重复某个字符或片段的问题，直到达到长度限制才停止。这种情况会导致：

1. 翻译质量严重下降
2. 浪费计算资源
3. 影响用户体验

## 解决方案

我们实现了多层次的重复检测和截断机制：

### 1. 实时流式检测（Stream Detection）

在流式输出过程中实时检测重复：
- 监控最近500字符的输出
- 当单个字符连续重复超过阈值时立即停止生成
- 默认阈值：8次（严格模式：5次）

### 2. 单字符重复检测

检测并截断连续重复的单个字符：
- 正常模式：单字符最多重复10次
- 严格模式：单字符最多重复5次
- 当检测到超过阈值3倍的重复时，直接截断整个文本

### 3. 片段重复检测

检测并截断重复的文本片段：
- 检测5-100字符长度的重复片段
- 正常模式：片段最多重复5次
- 严格模式：片段最多重复3次

### 4. 后处理质量检测

在翻译完成后进行质量检测：
- 检测异常结尾模式
- 检测非中文/日文字符过多
- 检测标点符号缺失
- 检测翻译完整性

## 使用方法

### 基本使用

```bash
python -m src.translate_v3 input.txt --model "Qwen/Qwen3-32B-AWQ"
```

### 启用严格重复检测

```bash
python -m src.translate_v3 input.txt --strict-repetition-check
```

### 启用流式输出（推荐）

```bash
python -m src.translate_v3 input.txt --stream --strict-repetition-check
```

## 配置参数

### 正常模式配置
- `max_repeat_chars`: 10（单字符最大重复次数）
- `max_repeat_segments`: 5（片段最大重复次数）
- `stream_threshold`: 8（流式检测阈值）
- `basic_char_threshold`: 8（基础检测单字符阈值）

### 严格模式配置
- `max_repeat_chars`: 5
- `max_repeat_segments`: 3
- `stream_threshold`: 5
- `basic_char_threshold`: 5

## 测试验证

运行测试套件验证功能：

```bash
python tasks/translation/scripts/test_repetition_detection.py
```

测试包括：
- 单字符重复检测测试
- 片段重复检测测试
- 配置模式测试
- 真实案例测试

## 效果展示

### 修复前
```
这是一个测试噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜噜文本
```

### 修复后
```
这是一个测试噜噜噜噜噜
```

## 技术细节

### 检测算法

1. **流式检测**：在生成过程中维护一个滑动窗口，实时检测重复模式
2. **字符级检测**：遍历文本，统计连续相同字符的数量
3. **片段级检测**：在文本尾部搜索重复的子字符串
4. **质量评估**：使用多个启发式规则评估翻译质量

### 性能优化

- 只在必要时进行片段检测（文本长度 > 20字符）
- 使用高效的字符串搜索算法
- 限制检测范围（最后1000字符）
- 早期截断严重重复案例

## 注意事项

1. 严格模式可能会误截断正常的重复内容（如"哈哈哈哈哈"）
2. 流式检测需要启用 `--stream` 参数
3. 建议在处理大量文件时启用严格模式以节省计算资源
4. 检测阈值可根据具体需求调整

## 更新日志

- 2024-01-XX: 初始实现重复检测功能
- 2024-01-XX: 添加流式检测支持
- 2024-01-XX: 添加严格模式配置
- 2024-01-XX: 完善测试套件
