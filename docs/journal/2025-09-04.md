# 2025-09-04 翻译脚本增强与配置优化

## 🔧 主要改进

### 1. Makefile 配置优化
- **问题**：硬编码了 data 文件夹结构 `tasks/translation/data/pixiv/[作品ID]`
- **解决**：改为使用 `INPUT_DIR` 参数，用户需手动指定输入目录
- **使用方式**：
  ```bash
  make translate-batch INPUT_DIR=tasks/translation/data/pixiv/[作品ID]
  make translate-batch-smart INPUT_DIR=tasks/translation/data/pixiv/[作品ID]
  ```

### 2. 翻译脚本安全性增强
- **问题**：`translate_pixiv_v1.py` 中硬编码了默认 preface 内容
- **解决**：强制要求提供 `preface_file` 参数，如果文件不存在则抛出 `ValueError`
- **好处**：确保所有翻译指令都来自外部文件，便于统一管理和修改

### 3. 翻译脚本功能大幅增强
- **新增功能**：
  - `--bilingual`：对照模式输出（日语原文+中文译文交错）
  - `--stream`：流式输出，实时显示模型生成过程
  - `--realtime-log`：实时日志输出，同时显示在控制台和文件中
  - `--no-llm-check`：禁用大模型质量检测，使用基础检测
- **质量检测**：
  - 大模型质量检测：使用 LLM 检查翻译完整性
  - 基础质量检测：长度比例、错误模式、重复字符等
  - 自动分块重试：质量不佳时自动使用更小块重试
- **日志优化**：
  - 统一日志函数 `log_message()`
  - 兼容性函数 `setup_realtime_logging()` 和 `log_realtime()`
  - 详细的翻译配置和文章信息记录
- **文件处理**：
  - YAML front matter 解析
  - 重复文件检测和清理
  - 智能跳过已翻译且质量良好的文件

### 4. 技术细节
- **YAML 解析**：`parse_yaml_front_matter()` 函数解析文章元数据
- **对照输出**：`create_bilingual_output()` 函数创建日语原文+中文译文交错格式
- **质量检测**：`check_translation_quality_with_llm()` 和 `check_translation_quality_basic()` 双重检测
- **流式处理**：支持实时显示翻译进度，提升用户体验

## 🎯 影响
- 提高了翻译脚本的灵活性和安全性
- 增强了翻译质量检测和自动重试机制
- 改善了用户体验（流式输出、实时日志）
- 为后续批量翻译任务提供了更强大的工具

## 📝 关键代码变更

### Makefile 变更
```makefile
# 批量翻译（带实时日志和质量检测）
translate-batch:
	@echo "📝 开始批量翻译..."
	@echo "请指定输入目录，例如：make translate-batch INPUT_DIR=tasks/translation/data/pixiv/[作品ID]"
	@if [ -z "$(INPUT_DIR)" ]; then echo "❌ 请设置 INPUT_DIR 参数"; exit 1; fi
	PYTHONUNBUFFERED=1 stdbuf -oL -eL $(PY) tasks/translation/scripts/translate_pixiv_v1.py $(INPUT_DIR) --model Qwen/Qwen3-32B --max-context-length 32768 --mode full --temperature 0.0 --frequency-penalty 0.0 --presence-penalty 0.0 --retries 1 --retry-wait 1.0 --fallback-on-context --terminology-file tasks/translation/data/terminology.txt --sample-file tasks/translation/data/samples/sample_bilingual.txt --preface-file tasks/translation/data/preface_bilingual.txt --log-dir tasks/translation/logs --bilingual --stream --realtime-log --overwrite
```

### translate_pixiv_v1.py 关键变更
```python
def translate_with_local_llm(text: str, model: str, temperature: float, max_tokens: int, terminology: Optional[str] = None, stop: Optional[List[str]] = None, frequency_penalty: Optional[float] = None, presence_penalty: Optional[float] = None, few_shot_samples: Optional[List[Tuple[str, str]]] = None, max_context_length: Optional[int] = None, preface_file: Optional[str] = None, bilingual: bool = False, stream: bool = False, logger: Optional[logging.Logger] = None) -> Tuple[str, str, Dict[str, int]]:
    # 组装带术语表的提示词
    if preface_file and Path(preface_file).exists():
        with open(preface_file, 'r', encoding='utf-8') as f:
            preface = f.read().strip() + "\n"
    else:
        raise ValueError("preface_file 参数是必需的，请提供包含翻译指令的文件路径")
```

## 🔍 问题解决过程

### 问题1：Makefile 硬编码路径
- **发现**：用户指出 Makefile 中暴露了 data 文件夹结构
- **分析**：硬编码路径降低了脚本的通用性
- **解决**：改为使用 `INPUT_DIR` 参数，增加参数验证

### 问题2：翻译脚本硬编码 preface
- **发现**：脚本中有大量硬编码的翻译指令
- **分析**：硬编码内容不利于维护和修改
- **解决**：强制要求外部 preface 文件，提高安全性

### 问题3：功能需求扩展
- **需求**：用户需要更多翻译功能（双语对照、流式输出等）
- **实现**：新增多个命令行参数，增强脚本功能
- **测试**：通过实际翻译任务验证功能正确性

## 📊 测试结果
- ✅ Makefile 参数化成功，支持任意输入目录
- ✅ 翻译脚本安全性提升，强制外部 preface 文件
- ✅ 新增功能正常工作（双语对照、流式输出、实时日志）
- ✅ 质量检测机制有效，能自动识别和重试

## 🚀 后续计划
- 继续优化翻译质量检测算法
- 考虑添加更多输出格式支持
- 优化批量翻译的性能和稳定性
