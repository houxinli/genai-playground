# 2025-09-03 vLLM 前台可观测+tmux后台

## 🔧 问题背景
后台运行时没有 TTY，tqdm 自动关闭，日志中无进度条；需要在"可观测性"和"可后台运行"之间取得平衡。

## 🛠️ 解决方案

### 前台模式
- **实现**：`manage_vllm.sh start` 使用 `script -q -f -c` 分配伪 TTY（tqdm 认为有终端），同时落盘日志
- **Make 目标**：`vllm-start`、`vllm-start-32b`
- **优势**：可以实时看到 tqdm 进度条，便于观察模型加载过程

### 后台模式
- **实现**：`manage_vllm.sh start-bg` 使用 `tmux + script` 运行，记录会话名到 `logs/vllm.pid`
- **Make 目标**：`vllm-start-bg`、`vllm-start-32b-bg`
- **优势**：可 `tmux attach -t vllm` 实时查看，支持后台运行

### 统一输出
- **实现**：将 stderr 合流到日志；`serve_vllm.sh` 采用 `python -u` 或 `PYTHONUNBUFFERED=1` 以避免缓冲吞掉刷新
- **效果**：确保所有输出都能正确记录到日志文件

## 🔧 其他改动

### DEBUG 开关
- **实现**：`serve_vllm.sh` 增加 DEBUG 开关：`DEBUG=1` 时提升 vLLM/HF 的日志等级
- **环境变量**：
  - `VLLM_LOGGING_LEVEL=DEBUG`
  - `HF_HUB_VERBOSITY=debug`

### 配置优化
- **32B 模型**：默认 `max-num-seqs=1` 保守并发，提高稳定性
- **上下文长度**：32B `max-model-len=32K`，AWQ `max-model-len=40K`
- **日志增强**：加入 `--uvicorn-log-level`、`--enable-log-requests`、`--enable-log-outputs`、`--max-log-len`

## 📋 Makefile 更新

### 前台启动
```makefile
vllm-start:
	@$(MAKE) vllm MODE=fg MODEL=$(MODEL) DEBUG=$(DEBUG)

vllm-start-32b:
	@$(MAKE) vllm MODE=fg MODEL=Qwen/Qwen3-32B DEBUG=$(DEBUG)
```

### 后台启动
```makefile
vllm-start-bg:
	@$(MAKE) vllm MODE=bg MODEL=$(MODEL) DEBUG=$(DEBUG)

vllm-start-32b-bg:
	@$(MAKE) vllm MODE=bg MODEL=Qwen/Qwen3-32B DEBUG=$(DEBUG)
```

### Debug 便捷目标
```makefile
vllm-start-debug:
	@$(MAKE) vllm-start DEBUG=1

vllm-start-bg-debug:
	@$(MAKE) vllm-start-bg DEBUG=1
```

## 🔍 技术细节

### script 命令
- **作用**：分配伪 TTY，让 tqdm 认为有终端
- **参数**：`-q` 静默模式，`-f` 强制输出，`-c` 执行命令

### tmux 会话管理
- **会话名**：`vllm`
- **PID 文件**：`logs/vllm.pid` 记录会话名而非进程 ID
- **查看方式**：`tmux attach -t vllm`

### Python 无缓冲输出
- **方法1**：`python -u` 参数
- **方法2**：`PYTHONUNBUFFERED=1` 环境变量
- **效果**：确保输出实时刷新，不被缓冲

## 📊 测试结果
- ✅ 前台模式：tqdm 进度条正常显示
- ✅ 后台模式：tmux 会话管理正常
- ✅ 日志记录：所有输出正确记录到文件
- ✅ DEBUG 模式：详细日志正常输出

## 🎯 使用建议
- **首次启动**：使用前台模式观察加载过程
- **稳定运行**：使用后台模式，需要时 tmux attach 查看
- **调试问题**：使用 DEBUG 模式获取详细日志
- **生产环境**：后台模式 + 日志监控

## 🔮 后续优化
- 考虑添加日志轮转机制
- 优化 tmux 会话的自动恢复
- 增加更细粒度的日志级别控制
